<script type="text/javascript">
    RED.nodes.registerType("odbc config", {
        category: "config",
        credentials: {
            password: { type: "password" }
        },
        defaults: {
            name: { value: "" },
            connectionMode: { value: "structured" },
            dbType: { value: "sqlserver" },
            driver: { value: "" },
            server: { value: "" },
            database: { value: "" },
            user: { value: "" },
            connectionString: { value: "" },
            initialSize: { value: 5 },
            incrementSize: { value: 5 },
            maxSize: { value: 15 },
            shrink: { value: true },
            connectionTimeout: { value: 3 },
            loginTimeout: { value: 3 },
            retryFreshConnection: { value: false },
            retryDelay: { value: 5, validate: RED.validators.number() },
            retryOnMsg: { value: true },
            syntaxtick: { value: false },
            syntax: { value: "mysql" },
        },
        label: function () {
            return this.name || "odbc config";
        },
        oneditprepare: function () {
            var node = this;

            // Logique pour les sections déroulantes
            $('.form-section-header').on('click', function() {
                $(this).toggleClass('expanded');
                $(this).next('.form-section-content').slideToggle();
            });

            // Logique pour le mode de connexion hybride
            function toggleConnectionMode(mode) {
                if (mode === 'structured') {
                    $(".config-mode-structured").show();
                    $(".config-mode-string").hide();
                } else {
                    $(".config-mode-structured").hide();
                    $(".config-mode-string").show();
                }
            }
            function toggleDriverField(dbType) {
                if (dbType === 'other') {
                    $("#node-config-driver-row").show();
                } else {
                    $("#node-config-driver-row").hide();
                }
            }
            
            $("#node-config-input-connectionMode").on("change", function() {
                toggleConnectionMode($(this).val());
            }).trigger("change");

            $("#node-config-input-dbType").on("change", function() {
                toggleDriverField($(this).val());
            }).trigger("change");

            // Logiques pour les cases à cocher
            $("#node-config-input-syntaxtick").on("change", function () {
                $(".input-syntax").toggle(this.checked);
            }).trigger("change");
            
            $("#node-config-input-retryFreshConnection").on("change", function() {
                $(".retry-options").toggle(this.checked);
            }).trigger("change");

            // Logique pour le bouton de test
            $('#node-config-test-connection').on('click', function() {
                var button = $(this);
                var originalText = "Test Connection";
                var icon = button.find("i");
                icon.removeClass('fa-bolt').addClass('fa-spinner fa-spin');
                button.text(' Testing...').prop('disabled', true);
                
                var connectionMode = $("#node-config-input-connectionMode").val();
                
                var configData = {
                    connectionMode: connectionMode,
                    dbType: $("#node-config-input-dbType").val(),
                    driver: $("#node-config-input-driver").val(),
                    server: $("#node-config-input-server").val(),
                    database: $("#node-config-input-database").val(),
                    user: $("#node-config-input-user").val(),
                    connectionString: $("#node-config-input-connectionString").val(),
                    // Le mot de passe n'est envoyé que si on est en mode structuré
                    password: (connectionMode === 'structured') ? $("#node-config-input-password").val() : null
                };

                $.ajax({
                    url: "odbc_config/" + node.id + "/test",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(configData),
                    success: function(result) {
                        RED.notify("Connection successful!", {type:"success", timeout: 2000});
                    },
                    error: function(xhr, status, error) {
                        var errMsg = xhr.responseText || "Connection failed. Check Node-RED logs for details.";
                        RED.notify("Connection failed: " + errMsg, {type:"error", timeout: 4000});
                    },
                    complete: function() {
                        button.text(originalText).prop('disabled', false);
                        icon.removeClass('fa-spinner fa-spin').addClass('fa-bolt');
                    }
                });
            });
        },
    });
</script>

<style>
    .form-section-header {
        cursor: pointer;
        padding: 5px;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
        user-select: none;
    }
    .form-section-header i.fa-caret-right {
        transition: transform 0.2s ease-in-out;
    }
    .form-section-header.expanded i.fa-caret-right {
        transform: rotate(90deg);
    }
    .form-section-content {
        padding-left: 20px;
    }
</style>

<script type="text/html" data-template-name="odbc config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="My DB Connection">
    </div>

    <div class="form-row">
        <label for="node-config-input-connectionMode"><i class="fa fa-cogs"></i> Mode</label>
        <select id="node-config-input-connectionMode">
            <option value="structured">Structured Fields (Recommended)</option>
            <option value="string">Connection String (Advanced)</option>
        </select>
    </div>

    <div class="config-mode-structured">
        <div class="form-row">
            <label for="node-config-input-dbType"><i class="fa fa-database"></i> Database Type</label>
            <select id="node-config-input-dbType">
                <option value="sqlserver">SQL Server</option>
                <option value="postgresql">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="other">Other (Specify Driver)</option>
            </select>
        </div>
        <div class="form-row" id="node-config-driver-row">
            <label for="node-config-input-driver"><i class="fa fa-info-circle"></i> Driver</label>
            <input type="text" id="node-config-input-driver" placeholder="e.g., IBM i Access ODBC Driver">
        </div>
        <div class="form-row">
            <label for="node-config-input-server"><i class="fa fa-server"></i> Server</label>
            <input type="text" id="node-config-input-server" placeholder="hostname_or_ip,port">
        </div>
        <div class="form-row">
            <label for="node-config-input-database"><i class="fa fa-table"></i> Database</label>
            <input type="text" id="node-config-input-database" placeholder="(optional)">
        </div>
        <div class="form-row">
            <label for="node-config-input-user"><i class="fa fa-user"></i> User</label>
            <input type="text" id="node-config-input-user">
        </div>
        <div class="form-row">
            <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
            <input type="password" id="node-config-input-password">
        </div>
    </div>
    
    <div class="config-mode-string">
        <div class="form-row">
            <label for="node-config-input-connectionString"><i class="fa fa-font"></i> Connection String</label>
            <input type="text" id="node-config-input-connectionString" placeholder="DRIVER={...};SERVER=...;UID=...;PWD=...;">
        </div>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <button class="ui-button" id="node-config-test-connection" style="width: auto;"><i class="fa fa-bolt"></i> Test Connection</button>
    </div>

    <hr/>
    
    <div class="form-section-header"><h4><i class="fa fa-caret-right"></i> <i class="fa fa-sitemap"></i> Pool Options</h4></div>
    <div class="form-section-content" style="display: none;">
        <div class="form-row">
            <label for="node-config-input-initialSize"><i class="fa fa-play"></i> Initial Size</label>
            <input type="number" id="node-config-input-initialSize" placeholder="5" />
        </div>
        <div class="form-row">
            <label for="node-config-input-incrementSize"><i class="fa fa-plus"></i> Increment Size</label>
            <input type="number" id="node-config-input-incrementSize" placeholder="5" />
        </div>
        <div class="form-row">
            <label for="node-config-input-maxSize"><i class="fa fa-stop"></i> Max Size</label>
            <input type="number" id="node-config-input-maxSize" placeholder="15" />
        </div>
        <div class="form-row">
            <label for="node-config-input-shrink"><i class="fa fa-compress"></i> Shrink Pool</label>
            <input type="checkbox" id="node-config-input-shrink" style="margin-left:0px; vertical-align:top; width:auto !important;" />
        </div>
        <div class="form-row">
            <label for="node-config-input-connectionTimeout"><i class="fa fa-clock-o"></i> Connection Timeout</label>
            <input type="number" id="node-config-input-connectionTimeout" placeholder="3" style="width: 80px;"/>
            <span style="margin-left: 5px;">seconds</span>
        </div>
        <div class="form-row">
            <label for="node-config-input-loginTimeout"><i class="fa fa-clock-o"></i> Login Timeout</label>
            <input type="number" id="node-config-input-loginTimeout" placeholder="3" style="width: 80px;" />
            <span style="margin-left: 5px;">seconds</span>
        </div>
    </div>
    
    <div class="form-section-header"><h4><i class="fa fa-caret-right"></i> <i class="fa fa-exclamation-triangle"></i> Error Handling & Retry</h4></div>
    <div class="form-section-content" style="display: none;">
        <div class="form-row">
            <label for="node-config-input-retryFreshConnection" style="width: auto;"><i class="fa fa-refresh"></i> Retry with fresh connection</label>
            <input type="checkbox" id="node-config-input-retryFreshConnection" style="display: inline-block; width: auto; vertical-align: top;" />
        </div>
        <div class="retry-options" style="padding-left: 20px;">
            <div class="form-row">
                <label for="node-config-input-retryDelay"><i class="fa fa-history"></i> Retry Delay</label>
                <input type="number" id="node-config-input-retryDelay" placeholder="5" style="width: 80px;" />
                 <span style="margin-left: 5px;">seconds</span>
            </div>
            <div class="form-row">
                <label for="node-config-input-retryOnMsg" style="width: auto;"><i class="fa fa-envelope-o"></i> Retry on new message</label>
                <input type="checkbox" id="node-config-input-retryOnMsg" style="display: inline-block; width: auto; vertical-align: top;" />
            </div>
        </div>
    </div>

    <div class="form-section-header"><h4><i class="fa fa-caret-right"></i> <i class="fa fa-wrench"></i> Advanced</h4></div>
    <div class="form-section-content" style="display: none;">
         <div class="form-row">
            <label for="node-config-input-syntaxtick" style="width: auto;"><i class="fa fa-check-square-o"></i> Syntax Checker</label>
            <input type="checkbox" id="node-config-input-syntaxtick" style="display: inline-block; width: auto; vertical-align: top;" />
        </div>
        <div class="form-row input-syntax">
            <label for="node-config-input-syntax"><i class="fa fa-language"></i> Syntax</label>
            <select id="node-config-input-syntax" style="width: 70%">
                <option value="bigquery">BigQuery</option>
                <option value="db2">DB2</option>
                <option value="hive">Hive</option>
                <option value="mariadb">MariaDB</option>
                <option value="mysql">Mysql</option>
                <option value="postgresql">PostgresQL</option>
                <option value="sqlite">Sqlite</option>
                <option value="transactsql">TransactSQL</option>
                <option value="flinksql">FlinkSQL</option>
            </select>
        </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("odbc", {
        category: "storage",
        color: "#89A5C0",
        defaults: {
            name: { value: "" },
            connection: { type: "odbc config", required: true },
            query: { value: "" },
            outputObj: { value: "payload" },
            streaming: { value: false },
            streamChunkSize: { value: 1, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 1,
        icon: "db.svg",
        label: function () {
            return this.name || "odbc";
        },
        oneditprepare: function () {
            this.editor = RED.editor.createEditor({
                id: "node-input-query-editor",
                mode: "ace/mode/sql",
                value: this.query,
            });
            
            $("#node-input-streaming").on("change", function() {
                $(".stream-options").toggle(this.checked);
            }).trigger("change");
        },
        oneditsave: function () {
            this.query = this.editor.getValue();
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
    });
</script>

<script type="text/html" data-template-name="odbc">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" />
    </div>
    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-cog"></i> Connection</label>
        <input type="text" id="node-input-connection" />
    </div>
    <div class="form-row node-text-editor-row">
        <label for="node-input-query" style="width: 100% !important;"><i class="fa fa-search"></i> Query</label>
        <div style="height: 250px;" class="node-text-editor" id="node-input-query-editor"></div>
    </div>
    <div class="form-row">
        <label for="node-input-outputObj"><i class="fa fa-edit"></i> Result to</label>
        <span>msg.</span><input type="text" id="node-input-outputObj" placeholder="payload" style="width: 64%;"/>
    </div>
    <hr/>
    <div class="form-row">
        <label for="node-input-streaming" style="width: auto;"><i class="fa fa-arrows-v"></i> Stream Results</label>
        <input type="checkbox" id="node-input-streaming" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row stream-options">
        <label for="node-input-streamChunkSize"><i class="fa fa-bars"></i> Chunk Size</label>
        <input type="number" id="node-input-streamChunkSize" placeholder="1" style="width: 100px;">
        <span class="form-tips">Number of rows per output message.</span>
    </div>
</script>