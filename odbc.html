<script type="text/javascript">
    RED.nodes.registerType("odbc config", {
        category: "config",
        credentials: {
            // Le mot de passe est défini comme un "credential" sécurisé
            password: { type: "password" }
        },
        defaults: {
            name: { value: "" },
            // Nouveaux champs pour le mode de connexion hybride
            connectionMode: { value: "structured" },
            dbType: { value: "sqlserver" },
            driver: { value: "" },
            server: { value: "" },
            database: { value: "" },
            user: { value: "" },
            connectionString: { value: "" },
            // Champs de pool et timeout
            initialSize: { value: 5 },
            incrementSize: { value: 5 },
            maxSize: { value: 15 },
            shrink: { value: true },
            connectionTimeout: { value: 3 },
            loginTimeout: { value: 3 },
            // Champs de retry
            retryFreshConnection: { value: false },
            retryDelay: { value: 5, validate: RED.validators.number() },
            retryOnMsg: { value: true },
            // Champs avancés
            syntaxtick: { value: false },
            syntax: { value: "mysql" },
        },
        label: function () {
            return this.name || "odbc config";
        },
        oneditprepare: function () {
            var node = this;

            // Logique pour afficher les bons champs selon le mode de connexion
            function toggleConnectionMode(mode) {
                if (mode === 'structured') {
                    $(".config-mode-structured").show();
                    $(".config-mode-string").hide();
                } else {
                    $(".config-mode-structured").hide();
                    $(".config-mode-string").show();
                }
            }
            // Gérer le changement du type de BD pour afficher/cacher le champ driver
            function toggleDriverField(dbType) {
                if (dbType === 'other') {
                    $("#node-config-driver-row").show();
                } else {
                    $("#node-config-driver-row").hide();
                }
            }
            
            // Initialisation de l'UI
            $("#node-config-input-connectionMode").on("change", function() {
                toggleConnectionMode($(this).val());
            }).trigger("change");

            $("#node-config-input-dbType").on("change", function() {
                toggleDriverField($(this).val());
            }).trigger("change");


            // Logique pour le 'Syntax Checker'
            $("#node-config-input-syntaxtick").on("change", function () {
                $(".input-syntax").toggle(this.checked);
            }).trigger("change");
            

            // Logique pour afficher/masquer les options de retry
            $("#node-config-input-retryFreshConnection").on("change", function() {
                $(".retry-options").toggle(this.checked);
            }).trigger("change");


            // Logique pour le bouton de test de connexion
            $('#node-config-test-connection').on('click', function() {
                var button = $(this);
                var originalText = button.text();
                var icon = button.find("i");
                icon.removeClass('fa-bolt').addClass('fa-spinner fa-spin');
                button.text(' Testing...').prop('disabled', true);
                
                // Collecter toutes les données du formulaire
                var configData = {
                    connectionMode: $("#node-config-input-connectionMode").val(),
                    dbType: $("#node-config-input-dbType").val(),
                    driver: $("#node-config-input-driver").val(),
                    server: $("#node-config-input-server").val(),
                    database: $("#node-config-input-database").val(),
                    user: $("#node-config-input-user").val(),
                    password: $("#node-config-input-password").val(),
                    connectionString: $("#node-config-input-connectionString").val()
                };

                $.ajax({
                    url: "odbc_config/" + node.id + "/test",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(configData),
                    success: function(result) {
                        RED.notify("Connection successful!", {type:"success", timeout: 2000});
                    },
                    error: function(xhr, status, error) {
                        var errMsg = xhr.responseText || "Connection failed. Check Node-RED logs for details.";
                        RED.notify("Connection failed: " + errMsg, {type:"error", timeout: 4000});
                    },
                    complete: function() {
                        button.text(originalText).prop('disabled', false);
                        icon.removeClass('fa-spinner fa-spin').addClass('fa-bolt');
                    }
                });
            });
        },
    });
</script>

<script type="text/html" data-template-name="odbc config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="My DB Connection">
    </div>

    <div class="form-row">
        <label for="node-config-input-connectionMode"><i class="fa fa-cogs"></i> Mode</label>
        <select id="node-config-input-connectionMode">
            <option value="structured">Structured Fields (Recommended)</option>
            <option value="string">Connection String (Advanced)</option>
        </select>
    </div>

    <div class="config-mode-structured">
        <div class="form-row">
            <label for="node-config-input-dbType"><i class="fa fa-database"></i> Database Type</label>
            <select id="node-config-input-dbType">
                <option value="sqlserver">SQL Server</option>
                <option value="postgresql">PostgreSQL</option>
                <option value="mysql">MySQL</option>
                <option value="other">Other (Specify Driver)</option>
            </select>
        </div>
        <div class="form-row" id="node-config-driver-row">
            <label for="node-config-input-driver"><i class="fa fa-info-circle"></i> Driver</label>
            <input type="text" id="node-config-input-driver" placeholder="e.g., IBM i Access ODBC Driver">
        </div>
        <div class="form-row">
            <label for="node-config-input-server"><i class="fa fa-server"></i> Server</label>
            <input type="text" id="node-config-input-server" placeholder="hostname_or_ip,port">
        </div>
        <div class="form-row">
            <label for="node-config-input-database"><i class="fa fa-table"></i> Database</label>
            <input type="text" id="node-config-input-database" placeholder="(optional)">
        </div>
        <div class="form-row">
            <label for="node-config-input-user"><i class="fa fa-user"></i> User</label>
            <input type="text" id="node-config-input-user">
        </div>
        <div class="form-row">
            <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
            <input type="password" id="node-config-input-password">
        </div>
    </div>
    
    <div class="config-mode-string">
        <div class="form-row">
            <label for="node-config-input-connectionString"><i class="fa fa-font"></i> Connection String</label>
            <input type="text" id="node-config-input-connectionString" placeholder="DRIVER={...};SERVER=...;PWD={{{password}}};">
        </div>
        <div class="form-row">
            <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
            <input type="password" id="node-config-input-password">
            <span class="form-tips">Use <code>{{{password}}}</code> placeholder in the string above.</span>
        </div>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <button class="ui-button" id="node-config-test-connection" style="width: auto;"><i class="fa fa-bolt"></i> Test Connection</button>
    </div>

    <hr/>
    <h4><i class="fa fa-sitemap"></i> Pool Options</h4>
    <hr/>
    <h4><i class="fa fa-exclamation-triangle"></i> Error Handling & Retry</h4>
    <hr/>
    <h4><i class="fa fa-wrench"></i> Advanced</h4>
    </script>

<script type="text/javascript">
    RED.nodes.registerType("odbc", {
        category: "storage-input",
        color: "#89A5C0",
        defaults: {
            name: { value: "" },
            connection: { type: "odbc config", required: true },
            query: { value: "" },
            outputObj: { value: "payload" },
            // Nouveaux champs pour le streaming
            streaming: { value: false },
            streamChunkSize: { value: 1, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 1,
        icon: "db.svg",
        label: function () {
            return this.name || "odbc";
        },
        oneditprepare: function () {
            this.editor = RED.editor.createEditor({
                id: "node-input-query-editor",
                mode: "ace/mode/sql",
                value: this.query,
            });
            
            // Logique pour afficher/cacher le champ de taille de lot
            $("#node-input-streaming").on("change", function() {
                $(".stream-options").toggle(this.checked);
            }).trigger("change");
        },
        oneditsave: function () {
            this.query = this.editor.getValue();
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function () {
            this.editor.destroy();
            delete this.editor;
        },
    });
</script>

<script type="text/html" data-template-name="odbc">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" />
    </div>

    <div class="form-row">
        <label for="node-input-connection"><i class="fa fa-cog"></i> Connection</label>
        <input type="text" id="node-input-connection" />
    </div>

    <div class="form-row node-text-editor-row">
        <label for="node-input-query" style="width: 100% !important;"><i class="fa fa-search"></i> Query</label>
        <div style="height: 250px;" class="node-text-editor" id="node-input-query-editor"></div>
    </div>

    <div class="form-row">
        <label for="node-input-outputObj"><i class="fa fa-edit"></i> Result to</label>
        <span>msg.</span><input type="text" id="node-input-outputObj" placeholder="payload" style="width: 64%;"/>
    </div>

    <hr/>
    <h4><i class="fa fa-sliders"></i> Advanced Options</h4>

    <div class="form-row">
        <label for="node-input-streaming" style="width: auto;"><i class="fa fa-arrows-v"></i> Stream Results</label>
        <input type="checkbox" id="node-input-streaming" style="display: inline-block; width: auto; vertical-align: top;">
    </div>

    <div class="form-row stream-options">
        <label for="node-input-streamChunkSize"><i class="fa fa-bars"></i> Chunk Size</label>
        <input type="number" id="node-input-streamChunkSize" placeholder="1" style="width: 100px;">
        <span class="form-tips">Number of rows per output message.</span>
    </div>
</script>